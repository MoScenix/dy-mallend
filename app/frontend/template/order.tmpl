{{ define `order` }}
{{ template `header` . }}

<style>
    :root {
        --subtle-gray: #f8fafc;
        --border-color: #e2e8f0;
        --text-main: #2d3748;
        --text-muted: #718096;
    }

    /* 让 modal-lg 更宽一点（可按需调 720/820/900） */
    .add-modal {
        max-width: 820px;
        margin: 0 auto;
    }

    /* 预览区域 */
    .preview-box {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 16px;
        border: 1px dashed var(--border-color);
        background: var(--subtle-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .preview-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-placeholder {
        text-align: center;
        color: var(--text-muted);
    }

    .order-page-wrapper {
        max-width: 1000px;
        margin: 3rem auto;
        padding: 0 1.5rem;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* --- 左侧个人资料卡片 --- */
    .profile-card {
        background: #fff;
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid var(--border-color);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.03);
        text-align: center;
        position: sticky;
        top: 2rem;
        transition: all 0.3s ease;
    }

    .avatar-wrapper {
        width: 90px;
        height: 90px;
        margin: 0 auto 1.2rem;
        position: relative;
        border-radius: 50%;
        overflow: hidden;
        background: var(--subtle-gray);
        border: 2px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        cursor: pointer;
    }

    .profile-avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .avatar-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        opacity: 0;
        transition: 0.2s;
        font-size: 1.2rem;
    }

    .avatar-wrapper:hover .avatar-overlay {
        opacity: 1;
    }

    /* 编辑区域微调 */
    .edit-group {
        margin-bottom: 0.75rem;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .profile-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        cursor: pointer;
        border-bottom: 1px solid transparent;
    }

    .profile-name:hover {
        border-bottom-color: var(--border-color);
    }

    .profile-desc {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin: 0;
        max-width: 200px;
        line-height: 1.4;
        cursor: pointer;
    }

    .inline-edit-input {
        border: 1px solid var(--accent-color);
        border-radius: 6px;
        padding: 4px 8px;
        font-size: inherit;
        text-align: center;
        width: 100%;
        background: var(--subtle-gray);
        outline: none;
    }

    .mini-edit-btn {
        font-size: 0.75rem;
        color: #cbd5e0;
        margin-left: 8px;
        cursor: pointer;
        transition: 0.2s;
    }

    .mini-edit-btn:hover {
        color: var(--accent-color);
    }

    /* --- 右侧产品列表 --- */
    .content-card {
        background: #fff;
        border-radius: 24px;
        padding: 2rem;
        border: 1px solid var(--border-color);
    }

    .list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .product-row {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 16px;
        transition: 0.2s;
        border: 1px solid transparent;
        margin-bottom: 0.5rem;
    }

    .product-row:hover {
        background: var(--subtle-gray);
        border-color: var(--border-color);
    }

    .p-img {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        object-fit: cover;
        background: #fff;
        border: 1px solid var(--border-color);
    }

    .p-info {
        flex: 1;
        padding-left: 1.2rem;
    }

    .p-name {
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.95rem;
    }

    .p-price {
        color: var(--accent-color);
        font-size: 0.85rem;
        font-weight: 700;
    }

    .del-btn {
        color: #fca5a5;
        padding: 8px;
        transition: 0.2s;
        border-radius: 8px;
    }

    .del-btn:hover {
        color: #ef4444;
        background: #fee2e2;
    }

    /* 浮动保存提示 */
    #saveToast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #2d3748;
        color: white;
        padding: 8px 20px;
        border-radius: 20px;
        font-size: 0.8rem;
        opacity: 0;
        transition: 0.3s;
        pointer-events: none;
        z-index: 1000;
    }
</style>

<div class="order-page-wrapper">
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="profile-card">
                <form id="profileForm">
                    <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
                        <input type="file" id="avatarInput" name="avatar" class="d-none" onchange="autoSaveProfile()">
                        {{ if .avatar }}
                        <img src="{{ .avatar }}" class="profile-avatar-img" id="avatarPreview">
                        {{ else }}
                        <div class="profile-avatar-img d-flex align-items-center justify-content-center text-muted"><i
                                class="fa-regular fa-user fs-2"></i></div>
                        {{ end }}
                        <div class="avatar-overlay"><i class="fa-solid fa-camera"></i></div>
                    </div>

                    <div class="edit-group">
                        <span class="profile-name" id="nameLabel" onclick="enterEdit('name')">{{ .user_name }}</span>

                        <input type="text" name="user_name" id="nameInput" class="inline-edit-input d-none"
                            value="{{ .user_name }}" onblur="exitEdit('name')">
                        <i class="fa-solid fa-pencil mini-edit-btn" onclick="enterEdit('name')"></i>
                    </div>

                    <div class="edit-group">
                        <span class="profile-desc" id="descLabel" onclick="enterEdit('desc')">{{ or .description `Add a
                            short bio...` }}</span>
                        <textarea name="description" id="descInput" class="inline-edit-input d-none"
                            onblur="exitEdit('desc')">{{ .description }}</textarea>
                        <i class="fa-solid fa-pencil mini-edit-btn" onclick="enterEdit('desc')"></i>
                    </div>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="content-card">
                <div class="list-header">
                    <h5 class="m-0 fw-bold">My Collection</h5>
                    <button class="btn btn-dark btn-sm rounded-pill px-3" data-bs-toggle="modal"
                        data-bs-target="#addModal">Add New</button>
                </div>

                <div id="productList">
                    {{ range .orders }}{{ range .Items }}
                    <div class="product-row" id="product-{{ .Id }}">
                        <img src="{{ .Picture }}" class="p-img">
                        <div class="p-info">
                            <div class="p-name">{{ .ProductName }}</div>
                            <div class="p-price">${{ .Cost }}</div>
                        </div>
                        <button onclick="deleteProduct('{{ .Id }}')" class="btn del-btn border-0">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                    {{ end }}{{ end }}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow add-modal" style="border-radius: 20px;">
            <form id="addProductForm">
                <div class="modal-body p-5">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h5 class="fw-bold m-0">Add Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="row g-4">
                        <!-- 左侧：表单 -->
                        <div class="col-md-7">
                            <input type="text" name="name" class="form-control mb-3" placeholder="Name" required>
                            <input type="number" step="0.01" name="price" class="form-control mb-3" placeholder="Price"
                                required>
                            <textarea name="description" class="form-control mb-3" rows="4"
                                placeholder="Description"></textarea>

                            <input type="file" id="pictureInput" name="picture" class="form-control mb-4"
                                accept="image/*" required>

                            <button type="submit" class="btn btn-primary w-100 rounded-pill py-2">
                                Confirm Upload
                            </button>
                        </div>

                        <!-- 右侧：图片预览 -->
                        <div class="col-md-5">
                            <div class="preview-box">
                                <img id="picturePreview" class="preview-img d-none" alt="preview">
                                <div id="previewPlaceholder" class="preview-placeholder">
                                    <i class="fa-regular fa-image fs-2"></i>
                                    <div class="mt-2 small text-muted">Choose an image to preview</div>
                                </div>
                            </div>
                            <div class="small text-muted mt-2">
                                支持 JPG/PNG，建议正方形图片效果更好
                            </div>
                        </div>
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>


<div id="saveToast">Changes Saved</div>

<script>
  // ====== 统一弹窗（最稳：先用 alert；想换成 toast 我再给你改）======
  function showMsg(msg) {
    alert(msg);
  }

  // ====== 统一请求封装：兼容 Success/success，HTTP 错误/业务错误都弹窗 ======
  async function requestJSON(url, options = {}) {
    let res;
    try {
      res = await fetch(url, options);
    } catch (e) {
      showMsg("网络错误：" + (e?.message || e));
      return { ok: false };
    }
    let data = null;
    const ct = res.headers.get("content-type") || "";

    if (ct.includes("application/json")) {
      try { data = await res.json(); } catch (_) { data = null; }
    } else {
      // 兼容后端返回纯文本错误
      try { data = await res.text(); } catch (_) { data = null; }
    }

    // HTTP 非 2xx
    if (!res.ok) {
      const msg =
        (data && (data.message || data.msg || data.error)) ||
        (typeof data === "string" ? data : "") ||
        ("请求失败，HTTP " + res.status);
      showMsg(msg);
      return { ok: false, data };
    }

    // 业务成功字段兼容：Success / success
    const success = data?.Success ?? data?.success;

    // 如果明确返回 false，则视为业务失败并弹窗
    if (success === false) {
      const msg = data?.message || data?.msg || data?.error || "操作失败";
      showMsg(msg);
      return { ok: false, data };
    }

    return { ok: true, data };
  }

  // ====== 切换到编辑模式 ======
  function enterEdit(id) {
    const label = document.getElementById(id + "Label");
    const input = document.getElementById(id + "Input");

    label.classList.add("d-none");
    input.classList.remove("d-none");

    if (id === "desc") {
      input.value = input.value.trim();
    }

    input.focus();
    const len = input.value.length;
    if (typeof input.setSelectionRange === "function") {
      input.setSelectionRange(len, len);
    }
  }

  // ====== 退出编辑模式并触发保存 ======
  async function exitEdit(id) {
    const label = document.getElementById(id + "Label");
    const input = document.getElementById(id + "Input");

    const newValue = input.value.trim();
    const oldValue = label.innerText.trim();

    label.innerText = newValue || (id === "name" ? "Your Name" : "Add a short bio...");
    label.classList.remove("d-none");
    input.classList.add("d-none");

    if (newValue !== oldValue) {
      console.log("检测到" + id + "变更，正在提交...");
      await autoSaveProfile();
    }
  }

  // ====== 自动保存个人资料（/order）======
  async function autoSaveProfile() {
    const form = document.getElementById("profileForm");
    const formData = new FormData(form);

    const r = await requestJSON("/order", { method: "POST", body: formData });
    if (r.ok) location.reload();
  }

  // ====== 删除商品（/order/product/delete）======
  async function deleteProduct(id) {
    if (!confirm("确定要删除吗？")) return;

    const r = await requestJSON(
      "/order/product/delete?id=" + encodeURIComponent(id),
      { method: "POST" }
    );

    if (r.ok) location.reload();
  }

  // ====== 添加商品（/order/product）======
  const addProductForm = document.getElementById("addProductForm");
  if (addProductForm) {
    addProductForm.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      const r = await requestJSON("/order/product", { method: "POST", body: formData });
      if (r.ok) location.reload();
    };
  }

  // ====== 图片预览 ======
  const pictureInput = document.getElementById("pictureInput");
  const picturePreview = document.getElementById("picturePreview");
  const previewPlaceholder = document.getElementById("previewPlaceholder");

  if (pictureInput) {
    pictureInput.addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      if (!file.type || !file.type.startsWith("image/")) {
        showMsg("请选择图片文件");
        e.target.value = "";
        return;
      }

      const url = URL.createObjectURL(file);
      picturePreview.src = url;
      picturePreview.classList.remove("d-none");
      previewPlaceholder.classList.add("d-none");
    });
  }
</script>

{{ template "footer" . }}
{{ end }}